function Config(){}function startup(){game=new Phaser.Game(Config.WIDTH,Config.HEIGHT,Phaser.CANVAS,"gameArea"),game.state.add("Boot",App.BootState),game.state.add("Preloader",App.PreloaderState),game.state.add("MainMenu",App.MainMenuState),game.state.add("Gameplay",App.GameplayState),game.state.add("GameComplete",App.GameCompleteState),game.state.start("Boot")}App.Commands=Class.extend({init:function(){this.releaseCoinSignal=new Phaser.Signal,this.taskStartSignal=new Phaser.Signal,this.taskCompleteSignal=new Phaser.Signal,this.levelCompleteSignal=new Phaser.Signal,this.levelFailSignal=new Phaser.Signal,this.tableCoinRemoveSignal=new Phaser.Signal},gameStart:function(){data.initLevels(),Config.TEST_GAME_COMPLETE?cmd.gameComplete():cmd.levelStart(Config.START_LEVEL)},levelStart:function(a){data.curLevel=data.levels[a],data.curTask=0,sounds.startLevelMusic(),game.state.start("Gameplay")},levelComplete:function(){game.state.getCurrentState().levelComplete(),data.curLevel.complete(),cookies.levelComplete(),sounds.play("sndLevelComplete")},levelNext:function(){var a=data.curLevel.id,b=data.levels[a+1];b?fader.fade(this.gotoNextLevel,this):cmd.gameComplete()},gotoNextLevel:function(){var a=data.curLevel.id;cmd.levelStart(a+1)},gameComplete:function(){fader.fade(this.doGameComplete,this)},doGameComplete:function(){game.state.start("GameComplete")}}),Config.VERSION="1.0",Config.WIDTH=800,Config.HEIGHT=600,Config.LANGUAGE="en",Config.ANIMATION=!0,Config.SOUNDS_ENABLED=!0,Config.TRANSPARENT=!1,Config.START_LEVEL=0,Config.TEST_GAME_COMPLETE=!1,Config.SHOW_FPS=!0,Config.OPEN_ALL_LEVELS=!0,Config.ENABLE_CHEAT=!1,Config.RELEASE=!1,Config.RELEASE&&(Config.ANIMATION=!0,Config.SOUNDS_ENABLED=!0,Config.TRANSPARENT=!1,Config.START_LEVEL=0,Config.TEST_GAME_COMPLETE=!1,Config.SHOW_FPS=!1,Config.OPEN_ALL_LEVELS=!1,Config.ENABLE_CHEAT=!1),App.Data=Class.extend({init:function(){this.curLevel=null,this.curTask=null,this.taskCoins=null,this.json=JSON.parse(JSON.stringify(game.cache.getJSON("jsonLevels"))),this.atlasName="atlas"},getAtlasKey:function(a){return this.atlasName+"/"+a+"_0000"},addAtlasSprite:function(a,b){var c=util.getParam(b,"x",0),d=util.getParam(b,"y",0),e=util.getParam(b,"center",!1),f=util.getParam(b,"parent",game.world),g=game.add.sprite(c,d,this.atlasName,this.getAtlasKey(a),f);return e&&g.anchor.set(.5,.5),g},initLevels:function(){this.levels=[];for(var a=0;a<this.json.levels.length;a++){var b=this.json.levels[a];"static"==b.type?this.addLevel(this.json.levels[a]):"random"==b.type&&this.addRandomLevel(b.start,b.time)}},addLevel:function(a){var b=this.levels.length,c=new App.Level(b,a);this.levels.push(c)},addRandomLevel:function(a,b){var c={};c.time=b,c.tasks=[];var d=this.getRandomTasks(a,5),e=this.getRandomTasks(a+1,4),f=this.getRandomTasks(a+2,1);c.tasks=d.concat(e).concat(f),this.addLevel(c)},getRandomTasks:function(a,b){for(var c=[],d=0;b>d;d++){do var e=this.getRandomCoins(a);while(!this.isUnique(c,e));c.push({coins:e})}return c},isUnique:function(a,b){for(var c=this.getSum(b),d=0;d<a.length;d++){var e=this.getSum(a[d].coins);if(e==c)return!1}return!0},getSum:function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b},getRandomCoins:function(a){for(var b=[.1,.5,1,2,5],c=[],d=0;a>d;d++){var e=Math.floor(Math.random()*b.length),f=b[e];c.push(f)}return c},getTaskCoinsSum:function(){for(var a=0,b=0;b<this.taskCoins.length;b++)a+=this.taskCoins[b];return a.toFixed(2)}}),App.Dialog=Class.extend({init:function(a,b){var c=util.getParam(b,"x",0),d=util.getParam(b,"y",0),e=util.getParam(b,"blockBack",!1),f=util.getParam(b,"doTween",!0);this.holder=new Phaser.Group(game,game.world),e&&(this.block=new Phaser.Sprite(game,0,0,"blackBack"),this.block.inputEnabled=!0,this.holder.add(this.block)),this.boxHolder=new Phaser.Group(game,this.holder),this.boxHolder.x=c,this.boxHolder.y=d,this.box=data.addAtlasSprite(a,{parent:this.boxHolder,center:!0}),f&&(this.boxHolder.alpha=0,this.boxHolder.scale.x=this.boxHolder.scale.y=.5,game.add.tween(this.boxHolder).to({alpha:1},500,Phaser.Easing.Linear.None,!0),game.add.tween(this.boxHolder.scale).to({x:1,y:1},500,Phaser.Easing.Back.Out,!0),e&&(this.block.alpha=0,game.add.tween(this.block).to({alpha:1},200,Phaser.Easing.Linear.None,!0)))},dissapear:function(){var a=game.add.tween(this.boxHolder).to({alpha:0},500,Phaser.Easing.Linear.None,!0);a.onComplete.add(this.destroy,this),game.add.tween(this.boxHolder).to({y:this.boxHolder.y-300},500,Phaser.Easing.Back.In,!0),game.add.tween(this.block).to({alpha:0},200,Phaser.Easing.Linear.None,!0)},destroy:function(){this.holder.destroy()}}),App.Level=Class.extend({init:function(a,b){this.id=a,this.json=b,this.reset()},reset:function(){this.isCompleted=!1,this.completeTime=0},complete:function(a){this.isCompleted=!0,this.completeTime=a}});var game,cmd,data,cookies,fader,sounds,util;App.Sounds=Class.extend({init:function(){this.musicChannel=void 0,this.music=void 0},startMusic:function(){Config.SOUNDS_ENABLED&&(this.musicChannel=game.add.audio("music",1,!0),this.musicChannel.play())},startLevelMusic:function(){Config.SOUNDS_ENABLED&&(this.music=game.sound.play("sndMusic",1,!0))},stopLevelMusic:function(){this.music&&(this.music.stop(),this.music=void 0)},stopMusic:function(){this.music&&(this.music.stop(),this.music=void 0)},play:function(a,b){var c=1;void 0!=b&&(c=b),Config.SOUNDS_ENABLED&&game.sound.play(a,c)}}),App.Util=Class.extend({init:function(){},getParam:function(a,b,c){return a&&"undefined"!=typeof a[b]?a[b]:c},pulse:function(a,b){void 0==b&&(b=1.2);var c=game.add.tween(a.scale).to({x:b,y:b},1e3,Phaser.Easing.Sinusoidal.InOut).to({x:1,y:1},1e3,Phaser.Easing.Sinusoidal.InOut).loop().start();return c},wobble:function(a,b){void 0==b&&(b=1);for(var c=game.add.tween(a.scale),d=0;b>d;d++){var c=c.to({x:1.2,y:.8},100,Phaser.Easing.Sinusoidal.InOut);c.to({x:1,y:1},100,Phaser.Easing.Sinusoidal.InOut)}c.start()},showWithAlpha:function(a,b){var c=util.getParam(b,"delay",0),d=util.getParam(b,"time",500),e=util.getParam(b,"y",0);if(a.alpha=0,game.add.tween(a).to({alpha:1},d,Phaser.Easing.Linear.None,!0,c),e){var f=a.y;a.y+=e,game.add.tween(a).to({y:f},d,Phaser.Easing.Cubic.Out,!0,c)}},showWithScale:function(a,b){var c=util.getParam(b,"delay",0),d=util.getParam(b,"time",500);return a.scale.x=a.scale.y=0,game.add.tween(a.scale).to({x:1,y:1},d,Phaser.Easing.Back.Out,!0,c)},slide:function(a,b){var c=util.getParam(b,"delay",0),d=util.getParam(b,"time",500),e=util.getParam(b,"x",0),f=util.getParam(b,"y",0),g=util.getParam(b,"alpha",0),h=util.getParam(b,"ease",Phaser.Easing.Cubic.Out),i=a.x,j=a.y;a.alpha=g,a.x+=e,a.y+=f,game.add.tween(a).to({alpha:1,x:i,y:j},d,h,!0,c)},formatTime:function(a){var b=Math.floor(a/60),c=a-60*b;return 10>b&&(b="0"+b),10>c&&(c="0"+c),b+":"+c},randomizeArray:function(a){for(var b,c,d=a.length;d>0;)c=Math.floor(Math.random()*d),d--,b=a[d],a[d]=a[c],a[c]=b;return a},randomizeAndCopyArray:function(a){var b=a.slice();return this.randomizeArray(b)},equalArrays:function(a,b){if(a.length!=b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0},getDist:function(a,b,c,d){var e=a-c,f=b-d;return Math.sqrt(e*e+f*f)}}),App.Coin=Class.extend({init:function(a,b,c,d){this.value=c,this.parent=d,this.group=game.add.group(d),this.parent.bringToTop(this.group),this.defaultsPos=new Phaser.Point(a,b),this.reset(),this.radius=40;var e="";.1==this.value?(e="coin10kop",this.radius=35):.5==this.value?(e="coin50kop",this.radius=40):1==this.value?(e="coin1Rouble",this.radius=40):2==this.value?(e="coin2Roubles",this.radius=46):5==this.value&&(e="coin5Roubles",this.radius=50),this.sprite=data.addAtlasSprite(e,{center:!0,parent:this.group})},reset:function(){this.setPos(this.defaultsPos.x,this.defaultsPos.y)},resetWithTween:function(){var a=this.group.x-this.defaultsPos.x,b=this.group.y-this.defaultsPos.y,c=Math.sqrt(a*a+b*b),d=Math.round(c);100>d?d=100:d>400&&(d=400),game.add.tween(this.group).to({x:this.defaultsPos.x,y:this.defaultsPos.y},d,Phaser.Easing.Quadratic.InOut,!0)},getX:function(){return this.group.x},getY:function(){return this.group.y},setPos:function(a,b){this.group.x=a,this.group.y=b},isPointInside:function(a,b){var c=this.getX()-a,d=this.getY()-b,e=Math.sqrt(c*c+d*d);return e<=this.radius?!0:!1},toTop:function(){this.parent.bringToTop(this.group)},moveAndDestroy:function(a,b){game.add.tween(this.group).to({x:a,y:b},500,Phaser.Easing.Quadratic.InOut,!0);var c=game.add.tween(this.group.scale).to({x:.2,y:.2},500,Phaser.Easing.Quadratic.InOut,!0);c.onComplete.addOnce(this.tweenComplete,this)},tweenComplete:function(){this.destroy()},destroy:function(){this.parent.remove(this.group)},destroyWithScale:function(){var a=game.add.tween(this.group.scale).to({x:0,y:0},500,Phaser.Easing.Quadratic.Out,!0);a.onComplete.addOnce(this.destroy,this)}}),App.CoinsIcon=Class.extend({init:function(a,b,c,d){this.group=game.add.group(b),this.group.x=c,this.group.y=d,this.tf=game.add.text(0,1,a.toString(),{font:"40px Arial",fill:"#222222"},this.group),this.tf.anchor.set(1,.5),this.sprite=data.addAtlasSprite("coinsIcon",{x:20,y:0,center:!0,parent:this.group})},update:function(a){this.tf.text=a.toString()},beAgressive:function(){var a=this.group,b=1.2;this.tween1=game.add.tween(a.scale).to({x:b,y:b},300,Phaser.Easing.Sinusoidal.InOut),this.tween2=game.add.tween(a.scale).to({x:1,y:1},300,Phaser.Easing.Sinusoidal.InOut),this.tween1.chain(this.tween2),this.tween2.chain(this.tween1),this.tween1.start()},beNormal:function(){this.tween1&&(this.tween1.stop(),this.tween2.stop(),this.tween1=null,this.tween2=null,this.group.scale.x=1,this.group.scale.y=1)}}),App.CompleteView=App.Dialog.extend({init:function(){this._super("levelCompleteBox",{x:400,y:300,blockBack:!1}),this.box.alpha=.8;var a=this.getTotalCoinsValue();this.title1Tf=game.add.text(0,-210,"Ура!",{font:"50px Arial",fill:"#000000",align:"center"},this.boxHolder),this.title1Tf.anchor.set(.5,.5),this.title2Tf=game.add.text(0,-162,"Ты настоящий мастер монеты!",{font:"24px Arial",fill:"#666666",align:"center"},this.boxHolder),this.title2Tf.anchor.set(.5,.5),this.title3Tf=game.add.text(0,-105,"Время прохождения: "+this.getTotalTime(),{font:"28px Arial",fill:"#006F9C",align:"center"},this.boxHolder),this.title3Tf.anchor.set(.5,.5),this.title4Tf=game.add.text(0,-63,"Накоплено: "+a+" руб",{font:"28px Arial",fill:"#006F9C",align:"center"},this.boxHolder),this.title4Tf.anchor.set(.5,.5),this.title5Tf=game.add.text(0,0,"Понравилась игра? Поделись с друзьями!",{font:"18px Arial",fill:"#333333",align:"center"},this.boxHolder),this.title5Tf.anchor.set(.5,.5),this.title6Tf=game.add.text(0,95,"БОНУС!\nПроверь себя на знание советских плакатов.\nЛучшему игроку автограф оставит лично Сталин.",{font:"16px Arial",fill:"#000000",align:"center"},this.boxHolder),this.title6Tf.anchor.set(.5,.5),this.ussr=new App.MyButton("ussr",this.ussrClick,this,{x:0,y:190,center:!0,wobble:!0,parentGroup:this.boxHolder}),this.showWithTweens()},getTotalTime:function(){for(var a=0,b=0;b<data.levels.length;b++)a+=data.levels[b].completeTime;return util.formatTime(a)},getTotalCoinsValue:function(){for(var a=0,b=0;b<data.levels.length;b++)for(var c=data.levels[b],d=0;d<c.json.tasks.length;d++)for(var e=c.json.tasks[d],f=0;f<e.coins.length;f++)a+=e.coins[f];return a.toFixed(2)},ussrClick:function(){window.open("http://postepenno.com/ussr","_blank")},showWithTweens:function(){util.slide(this.title1Tf,{delay:500,time:500,y:-20}),util.slide(this.title2Tf,{delay:1e3,time:500,y:-20}),util.slide(this.title3Tf,{delay:1500,time:500,y:-20}),util.slide(this.title4Tf,{delay:2e3,time:500,y:-20}),util.slide(this.title5Tf,{delay:2500,time:500,y:-20}),util.slide(this.title6Tf,{delay:3e3,time:500,y:-20}),util.slide(this.ussr.bt,{delay:3500,time:500,y:-20})}}),App.CreditsView=App.Dialog.extend({init:function(){this._super("levelCompleteBox",{x:400,y:300,blockBack:!0});var a="АВТОРЫ",b=game.add.text(0,-140,a,{font:"60px Arial",fill:"#000000",align:"center"},this.boxHolder);b.anchor.set(.5,.5),this.close=new App.MyButton("closeButton",this.closeClick,this,{x:175,y:-225,center:!0,parentGroup:this.boxHolder,wobble:!0}),this.logoBt=new App.MyButton("postepennoLogo",this.logoClick,this,{x:-100,y:-50,parentGroup:this.boxHolder})},closeClick:function(){this.dissapear(),this.close.disableClick()},logoClick:function(){window.open("http://postepenno.com","_blank")}}),App.Fader=Class.extend({init:function(a){this.game=a},fade:function(a,b){if(this.callback=a,this.scope=b,Config.ANIMATION){this.pic=game.add.sprite(0,0,"fader"),this.pic.alpha=0,this.pic.inputEnabled=!0;var c=game.add.tween(this.pic).to({alpha:.8},300,Phaser.Easing.Linear.None,!0);c.onComplete.addOnce(this.fadeInComplete,this)}else this.callback.call(this.scope)},fadeInComplete:function(){App.Fader.SHOULD_FADE_OUT=!0,this.callback.call(this.scope)},fadeOut:function(){App.Fader.SHOULD_FADE_OUT=!1,this.pic=game.add.sprite(0,0,"fader"),this.pic.inputEnabled=!0;var a=game.add.tween(this.pic).to({alpha:0},300,Phaser.Easing.Linear.None,!0);a.onComplete.addOnce(this.fadeOutComplete,this)},fadeOutComplete:function(){this.pic.destroy()}}),App.Fader.SHOULD_FADE_OUT=!1,App.GameLogic=Class.extend({init:function(){this.spritesGroup=game.add.group(game.world),this.coinsGroup=game.add.group(game.world),cmd.taskStartSignal.add(this.taskStartHandler,this),cmd.taskCompleteSignal.add(this.taskCompleteHandler,this),cmd.levelCompleteSignal.add(this.levelCompleteHandler,this),cmd.levelFailSignal.add(this.levelFailHandler,this),this.table=new App.Table(this.spritesGroup,this.coinsGroup),this.wallet=new App.Wallet(this,this.spritesGroup,this.coinsGroup),this.timer=new App.Timer(this.spritesGroup,{x:550,y:50}),this.coinsIcon=new App.CoinsIcon(0,this.spritesGroup,410,50),cmd.releaseCoinSignal.add(this.releaseCoinHandler,this),cmd.tableCoinRemoveSignal.add(this.tableCoinRemoveHandler,this),this.createTaskItems()},createTaskItems:function(){this.taskItems=[];for(var a=0;a<data.curLevel.json.tasks.length;a++){var b=new App.TaskItem(a,data.curLevel.json.tasks[a],this.spritesGroup);this.taskItems.push(b)}},tableCoinRemoveHandler:function(){this.updateState()},releaseCoinHandler:function(){this.updateState()},updateState:function(){this.coinsIcon.update(this.table.coins.length);var a=data.taskCoins.length,b=this.table.coins.length,c=data.getTaskCoinsSum(),d=this.table.getCoinsTotal();if(c==d&&a!=b)this.coinsIcon.beAgressive(),this.taskItems[data.curTask].icon.beAgressive();else{this.coinsIcon.beNormal();var e=this.taskItems[data.curTask];e&&e.icon.beNormal()}},levelFailHandler:function(){sounds.stopLevelMusic(),sounds.play("sndBell"),this.levelFailView=new App.LevelFailView},taskStartHandler:function(){data.taskCoins=data.curLevel.json.tasks[data.curTask].coins,this.taskItems[data.curTask].start()},taskCompleteHandler:function(){this.taskItems[data.curTask].complete(),data.curTask++,data.curTask==data.curLevel.json.tasks.length?cmd.levelCompleteSignal.dispatch():(sounds.play("sndCorrect"),cmd.taskStartSignal.dispatch())},levelCompleteHandler:function(){this.levelCompleteView=new App.LevelCompleteView;var a=data.curLevel.json.time-this.timer.time;data.curLevel.complete(a),sounds.stopLevelMusic(),sounds.play("sndLevelComplete")},update:function(){this.wallet.update(),this.table.update(),this.levelCompleteView&&this.levelCompleteView.update(),this.levelFailView&&this.levelFailView.update()},destroy:function(){cmd.taskStartSignal.remove(this.taskStartHandler,this),cmd.taskCompleteSignal.remove(this.taskCompleteHandler,this),cmd.levelCompleteSignal.remove(this.levelCompleteHandler,this),cmd.levelFailSignal.remove(this.levelFailHandler,this),cmd.releaseCoinSignal.remove(this.releaseCoinHandler,this),cmd.tableCoinRemoveSignal.remove(this.tableCoinRemoveHandler,this),this.table.destroy(),this.wallet.destroy(),this.timer.destroy()}}),App.GameTitle=Class.extend({init:function(a,b){this.group=game.add.group(),this.group.x=a,this.group.y=b,this.sprite=data.addAtlasSprite("gameTitle",{parent:this.group,center:!0})},update:function(){}}),App.LevelCompleteView=App.Dialog.extend({init:function(){this._super("levelCompleteBox",{x:400,y:300,blockBack:!0}),this.time=0,this.next=new App.MyButton("nextButton",this.nextClick,this,{x:0,y:205,center:!0,parentGroup:this.boxHolder,wobble:!0});var a=data.curLevel.id;a>7&&(a=7);var b=data.json.heroes[a];this.title1Tf=game.add.text(0,-220,"Новый уровень!",{font:"40px Arial",fill:"#333333"},this.boxHolder),this.title1Tf.anchor.set(.5,.5);var c=b.name;this.title2Tf=game.add.text(0,50,c,{font:"40px Arial",fill:"#333333"},this.boxHolder),this.title2Tf.anchor.set(.5,.5);var d='"'+b.quote+'"';this.title3Tf=game.add.text(0,120,d,{font:"20px Arial",fill:"#333333"},this.boxHolder),this.title3Tf.anchor.set(.5,.5),this.title3Tf.align="center",this.title3Tf.wordWrap=!0,this.title3Tf.wordWrapWidth=390,this.avatar=data.addAtlasSprite(b.asset,{x:0,y:-80,parent:this.boxHolder,center:!0}),this.showWithTweens()},showWithTweens:function(){util.slide(this.title1Tf,{delay:500,x:-30}),util.showWithScale(this.avatar,{delay:800}),util.slide(this.title2Tf,{delay:1e3,x:-30}),util.showWithAlpha(this.title3Tf,{delay:1500}),util.showWithAlpha(this.next.bt,{delay:2e3})},nextClick:function(){this.next.disableClick(),data.curLevel.id==data.levels.length-1?cmd.gameComplete():fader.fade(this.nextLevel,this)},nextLevel:function(){cmd.levelStart(data.curLevel.id+1)},update:function(){this.avatar.angle=5*Math.sin(this.time),this.time+=.03}}),App.LevelFailView=App.Dialog.extend({init:function(){this._super("levelCompleteBox",{x:400,y:300,blockBack:!0}),this.time=0,this.home=new App.MyButton("homeButton",this.homeClick,this,{x:-70,y:180,center:!0,parentGroup:this.boxHolder,wobble:!0}),this.restart=new App.MyButton("restartButton",this.restartClick,this,{x:70,y:180,center:!0,parentGroup:this.boxHolder,wobble:!0}),this.title1Tf=game.add.text(0,-180,"Время вышло",{font:"50px Arial",fill:"#333333"},this.boxHolder),this.title1Tf.anchor.set(.5,.5),this.avatar=data.addAtlasSprite("heroGrumpy",{x:0,y:-20,parent:this.boxHolder,center:!0}),this.showWithTweens()},showWithTweens:function(){util.slide(this.title1Tf,{delay:500,x:-30}),util.showWithScale(this.avatar,{delay:800}),util.showWithAlpha(this.home.bt,{delay:1e3}),util.showWithAlpha(this.restart.bt,{delay:1200})},homeClick:function(){fader.fade(this.gotoMainMenu,this)},gotoMainMenu:function(){game.state.start("MainMenu")},restartClick:function(){fader.fade(this.restartLevel,this)},restartLevel:function(){cmd.levelStart(data.curLevel.id)},update:function(){this.avatar.angle=5*Math.sin(this.time),this.time+=.03}}),App.MoneyFountain=Class.extend({init:function(){this.group=game.add.group(game.world),this.coins=[],this.delay=0},addCoin:function(){var a=[.1,.5,1,2,5],b=Math.floor(Math.random()*a.length),c=100+Math.floor(Math.random()*(Config.WIDTH-200)),d=Config.HEIGHT+100,e=new App.Coin(c,d,a[b],this.group);e.speedX=-5+10*Math.random(),e.speedY=-16-5*Math.random(),e.g=.2+.3*Math.random(),e.dangle=-3+6*Math.random(),this.coins.push(e)},removeCoin:function(a){var b=this.coins.indexOf(a);this.coins.splice(b,1),a.destroy()},update:function(){for(var a=this.coins.length-1;a>=0;a--){var b=this.coins[a];b.speedY+=b.g,b.group.x+=b.speedX,b.group.y+=b.speedY,b.sprite.angle+=b.dangle,b.group.y>=Config.HEIGHT+150&&this.removeCoin(b)}this.delay<=0?(this.addCoin(),this.delay=10+Math.floor(20*Math.random())):this.delay--}}),App.MyButton=Class.extend({init:function(a,b,c,d){this.callback=b,this.callbackContext=c;var e=util.getParam(d,"x",0),f=util.getParam(d,"y",0),g=util.getParam(d,"center",!1),h=util.getParam(d,"parentGroup",game.world),i=util.getParam(d,"atlas",!0);if(this.wobble=util.getParam(d,"wobble",!1),i){var j=data.getAtlasKey(a);this.bt=game.add.button(e,f,data.atlasName,this.clickHandler,this,j,j,j,j,h)}else this.bt=game.add.button(e,f,a,this.clickHandler,this,null,null,null,null,h);this.bt.input.useHandCursor=!0,g&&this.bt.anchor.set(.5,.5)},clickHandler:function(){sounds.play("sndClick"),this.wobble&&util.wobble(this.bt),this.callback.call(this.callbackContext)},scaleHide:function(){game.add.tween(this.bt.scale).to({x:0,y:0},200,Phaser.Easing.Linear.None,!0)},scaleShow:function(){game.add.tween(this.bt.scale).to({x:1,y:1},200,Phaser.Easing.Linear.None,!0)},hide:function(){this.bt.scale.x=this.bt.scale.y=0},show:function(){this.bt.scale.x=this.bt.scale.y=1},disableClick:function(){this.bt.inputEnabled=!1},enableClick:function(){this.bt.inputEnabled=!0},destroy:function(){this.bt.destroy()}}),App.SoundIcon=Class.extend({init:function(a){var b=util.getParam(a,"x",0),c=util.getParam(a,"y",0),d=util.getParam(a,"scale",1),e=util.getParam(a,"parentGroup",game.world);this.group=game.add.group(e),this.group.x=b,this.group.y=c,this.group.scale.x=this.group.scale.y=d,this.btOn=new App.MyButton("soundIconOn",this.sndClick,this,{center:!0,parentGroup:this.group}),this.btOff=new App.MyButton("soundIconOff",this.sndClick,this,{center:!0,parentGroup:this.group}),this.updateIcon()},updateIcon:function(){Config.SOUNDS_ENABLED?(this.btOn.show(),this.btOff.hide()):(this.btOn.hide(),this.btOff.show())},hide:function(){this.group.visible=!1},sndClick:function(){Config.SOUNDS_ENABLED=!Config.SOUNDS_ENABLED,"Gameplay"==game.state.current&&(Config.SOUNDS_ENABLED?sounds.startLevelMusic():sounds.stopLevelMusic()),this.updateIcon(),util.wobble(this.group)},disableClick:function(){this.btOn.disableClick(),this.btOff.disableClick()}}),App.Table=Class.extend({init:function(a,b){this.coinsGroup=b,this.x=270,this.y=90,this.width=520,this.height=350,this.activeItem=null,this.dragOffset=void 0,this.sprite=data.addAtlasSprite("tableBack",{parent:a}),this.sprite.x=this.x,this.sprite.y=this.y,this.coins=[],this.sumTf=game.add.text(0,0,"0",{font:"90px Arial",fill:"#999999"},a),this.sumTf.anchor.set(.5,.5),this.sumTf.x=this.x+this.width/2+6,this.sumTf.y=this.y+this.height/2+5,this.updateSum(),cmd.releaseCoinSignal.add(this.releaseCoinHandler,this),cmd.levelFailSignal.add(this.levelFailHandler,this),game.input.onDown.add(this.touchDownHandler,this)},levelFailHandler:function(){game.input.onDown.remove(this.touchDownHandler,this)},drawBounds:function(a){var b=game.add.graphics(this.x,this.y,a);b.lineStyle(2,0,1),b.drawRect(0,0,this.width,this.height)},updateSum:function(){this.sumTf.text=this.getCoinsTotal()+"р"},getCoinsTotal:function(){for(var a=0,b=0;b<this.coins.length;b++){var c=this.coins[b];a+=c.value}return a.toFixed(2)},maybeTaskComplete:function(){this.coins.length==data.taskCoins.length&&this.getCoinsTotal()==data.getTaskCoinsSum()&&(this.clear(),cmd.taskCompleteSignal.dispatch())},clear:function(){for(var a=125,b=40+55*data.curTask+25,c=(new App.CoinsMover(this.coins,a,b),this.coins.length-1);c>=0;c--)this.removeCoin(this.coins[c]);this.updateSum()},touchDownHandler:function(a){var b=Math.round(a.x),c=Math.round(a.y),d=this.getCoinUnderPoint(b,c);d&&(this.activeItem=d,this.activeItem.toTop(),this.dragOffset=new Phaser.Point(b-d.getX(),c-d.getY()),game.input.onUp.add(this.touchUpHandler,this))},touchUpHandler:function(){game.input.onUp.remove(this.touchUpHandler,this),this.isPointInBounds(this.activeItem.getX(),this.activeItem.getY())||(this.removeCoin(this.activeItem),this.activeItem.destroyWithScale(),this.updateSum(),this.maybeTaskComplete(),cmd.tableCoinRemoveSignal.dispatch()),this.activeItem=null},getCoinUnderPoint:function(a,b){for(var c=void 0,d=-1,e=0;e<this.coins.length;e++){var f=this.coins[e];f.isPointInside(a,b)&&f.group.z>d&&(c=f,d=f.group.z)}return c},releaseCoinHandler:function(a){this.isPointInBounds(a.x,a.y)&&(this.addCoin(a.x,a.y,a.value),this.updateSum(),this.maybeTaskComplete())},addCoin:function(a,b,c){var d=new App.Coin(a,b,c,this.coinsGroup);this.coins.push(d)},removeCoin:function(a){var b=this.coins.indexOf(a);this.coins.splice(b,1)},isPointInBounds:function(a,b){var c=this.x,d=this.x+this.width,e=this.y,f=this.y+this.height;return a>=c&&d>=a&&b>=e&&f>=b?!0:!1},update:function(){if(this.activeItem){var a=game.input.activePointer,b=Math.round(a.position.x)-this.dragOffset.x,c=Math.round(a.position.y)-this.dragOffset.y;this.activeItem.setPos(b,c)}},destroy:function(){cmd.releaseCoinSignal.remove(this.releaseCoinHandler,this),cmd.levelFailSignal.remove(this.levelFailHandler,this)}}),App.CoinsMover=Class.extend({init:function(a,b,c){this.coins=a;for(var d=0;d<this.coins.length;d++){var e=this.coins[d];e.moveAndDestroy(b,c)}}}),App.TaskItem=Class.extend({init:function(a,b,c){this.id=a,this.task=b,this.defaultX=5,this.defaultY=45+55*a;var d=this.defaultY;this.group=game.add.group(c),this.group.x=this.defaultX,this.group.y=d,this.sprite=data.addAtlasSprite("taskItemNormal",{parent:this.group}),this.icon=new App.CoinsIcon(this.task.coins.length,this.group,45,25);var e=this.getTaskTotal();this.totalTf=game.add.text(100,3,e,{font:"40px Arial",fill:"#000000"},this.group),this.rubTf=game.add.text(0,0,"руб",{font:"20px Arial",fill:"#000000"},this.group),this.rubTf.x=this.totalTf.x+this.totalTf.width+2,this.rubTf.y=this.totalTf.y+this.totalTf.height-this.rubTf.height-5},start:function(){this.group.remove(this.sprite),this.sprite=data.addAtlasSprite("taskItemActive",{parent:this.group}),this.group.sendToBack(this.sprite),game.add.tween(this.group).to({x:this.defaultX+25},300,Phaser.Easing.Quadratic.InOut,!0)},complete:function(){this.group.remove(this.sprite),this.sprite=data.addAtlasSprite("taskItemComplete",{parent:this.group}),this.group.sendToBack(this.sprite),game.add.tween(this.group).to({x:this.defaultX},300,Phaser.Easing.Quadratic.InOut,!0)},getTaskTotal:function(){for(var a=0,b=0;b<this.task.coins.length;b++)a+=this.task.coins[b];return a.toFixed(2)}}),App.Timer=Class.extend({init:function(a,b){var c=util.getParam(b,"x",0),d=util.getParam(b,"y",0);this.group=game.add.group(a),this.group.x=c,this.group.y=d,data.addAtlasSprite("timerBack",{center:!0,parent:this.group}),this.tf=game.add.text(0,0,"00:00",{font:"bold 50px Arial",fill:"#FFFFFF"},this.group),this.tf.anchor.set(.5,.5),this.time=data.curLevel.json.time,this.updateView(),cmd.levelCompleteSignal.add(this.levelCompleteHandler,this),cmd.levelFailSignal.add(this.levelFailHandler,this),cmd.taskStartSignal.add(this.firstTaskStartHandler,this)},firstTaskStartHandler:function(){this.tickEvent=game.time.events.loop(Phaser.Timer.SECOND,this.tick,this),cmd.taskStartSignal.remove(this.firstTaskStartHandler,this)},levelCompleteHandler:function(){game.time.events.remove(this.tickEvent)},levelFailHandler:function(){console.log("Time's out!"),game.time.events.remove(this.tickEvent)},tick:function(){this.time--,5==this.time&&(this.tf.fill="#FC3512"),this.updateView(),sounds.play("sndTick",.7),this.time<=0&&cmd.levelFailSignal.dispatch()},updateView:function(){this.tf.text=util.formatTime(this.time)},destroy:function(){cmd.levelCompleteSignal.remove(this.levelCompleteHandler,this),cmd.levelFailSignal.remove(this.levelFailHandler,this)}}),App.TutorialView=App.Dialog.extend({init:function(){this._super("tutorialBox",{x:400,y:300,blockBack:!0}),this.next=new App.MyButton("okButton",this.nextClick,this,{x:0,y:215,center:!0,parentGroup:this.boxHolder,wobble:!0})},nextClick:function(){this.next.disableClick(),this.dissapear(),cmd.taskStartSignal.dispatch()}}),App.Wallet=Class.extend({init:function(a,b,c){this.logic=a,this.coinsGroup=c,this.x=330,this.y=445,this.activeItem=null,this.dragOffset=void 0,this.sprite=data.addAtlasSprite("walletBack",{parent:b}),this.sprite.x=this.x,this.sprite.y=this.y,this.coins=[],this.addCoin(72,98,.1),this.addCoin(147,66,.5),this.addCoin(228,93,1),this.addCoin(316,65,2),this.addCoin(415,85,5),cmd.levelCompleteSignal.add(this.levelCompleteHandler,this),cmd.levelFailSignal.add(this.levelFailHandler,this),cmd.taskStartSignal.add(this.firstTaskStartHandler,this)},firstTaskStartHandler:function(){game.input.onDown.add(this.touchDownHandler,this),cmd.taskStartSignal.remove(this.firstTaskStartHandler,this)},levelFailHandler:function(){game.input.onDown.remove(this.touchDownHandler,this)},addCoin:function(a,b,c){var d=new App.Coin(this.x+a,this.y+b,c,this.coinsGroup);this.coins.push(d)},touchDownHandler:function(a){var b=Math.round(a.x),c=Math.round(a.y),d=this.getCoinUnderPoint(b,c);d&&(this.activeItem=d,this.activeItem.toTop(),this.dragOffset=new Phaser.Point(b-d.getX(),c-d.getY()),game.input.onUp.add(this.touchUpHandler,this))},touchUpHandler:function(){game.input.onUp.remove(this.touchUpHandler,this);var a=this.activeItem.getX(),b=this.activeItem.getY(),c=this.activeItem.value,d={x:a,y:b,value:c};cmd.releaseCoinSignal.dispatch(d),this.logic.table.isPointInBounds(a,b)?this.activeItem.reset():this.activeItem.resetWithTween(),this.activeItem=null},getCoinUnderPoint:function(a,b){for(var c=0;c<this.coins.length;c++){var d=this.coins[c];if(d.isPointInside(a,b))return d}},update:function(){if(this.activeItem){var a=game.input.activePointer,b=Math.round(a.position.x)-this.dragOffset.x,c=Math.round(a.position.y)-this.dragOffset.y;this.activeItem.setPos(b,c)}},levelCompleteHandler:function(){game.input.onDown.remove(this.touchDownHandler,this)},destroy:function(){cmd.taskStartSignal.remove(this.firstTaskStartHandler,this),cmd.levelCompleteSignal.remove(this.levelCompleteHandler,this),cmd.levelFailSignal.remove(this.levelFailHandler,this)}}),App.BootState=function(){},App.BootState.prototype={preload:function(){this.load.image("preloadBar","assets/images/preloadBar.png"),this.load.image("preloadBarHolder","assets/images/preloadBarHolder.png"),this.load.image("background","assets/images/background.jpg"),this.load.image("cuteBack1.jpg","assets/images/cuteBack1.jpg"),game.stage.backgroundColor="#EBE7DA"},create:function(){this.game.input.maxPointers=1,game.device.desktop?this.desktopMode():this.mobileMode(),Config.TRANSPARENT&&(this.game.world.alpha=.5),this.game.state.start("Preloader")},desktopMode:function(){var a="0px auto",b="800px",c="600px",d="0px 4px 17px 0px rgba(0,0,0,0.77)",e=document.getElementById("gameArea");e.style.width=b,e.style.height=c,e.style.margin=a,e.style["box-shadow"]=d,e.style["-webkit-box-shadow"]=d,e.style["-moz-box-shadow"]=d},mobileMode:function(){game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,game.scale.pageAlignHorizontally=!0,game.scale.pageAlignVertically=!0,game.scale.enterPortrait.add(this.rescale,this),game.scale.enterLandscape.add(this.rescale,this),game.scale.setScreenSize(!0)},rescale:function(){var a=this.game;setTimeout(function(){a.scale.refresh()},500)}},App.GameCompleteState=function(){},App.GameCompleteState.prototype={create:function(){this.add.sprite(0,0,"cuteBack1.jpg"),this.fountain=new App.MoneyFountain,this.dialog=new App.CompleteView,this.home=new App.MyButton("homeButton",this.homeClick,this,{x:755,y:555,center:!0,wobble:!0})},update:function(){this.fountain.update()},homeClick:function(){fader.fade(this.gotoMainMenu,this)},gotoMainMenu:function(){game.state.start("MainMenu")}},App.GameplayState=function(){},App.GameplayState.prototype={create:function(){this.add.sprite(0,0,"cuteBack1.jpg"),this.home=new App.MyButton("homeButton",this.homeClick,this,{x:760,y:50,center:!0,wobble:!0}),this.soundIcon=new App.SoundIcon({x:680,y:50}),Config.ENABLE_CHEAT&&(this.cheat=new App.MyButton("cheatButton",this.cheatClick,this,{x:300,y:50,center:!0,wobble:!0})),this.logic=new App.GameLogic,this.levelTf=game.add.text(122,5,"Уровень",{font:"30px Arial",fill:"#FFFFFF"},game.world),this.levelTf.anchor.set(.5,0);var a="Уровень "+(data.curLevel.id+1)+"/"+data.levels.length;this.levelTf.text=a,0==data.curLevel.id?new App.TutorialView:this.showWithTweens(),App.Fader.SHOULD_FADE_OUT&&fader.fadeOut()},showWithTweens:function(){for(var a=0;a<this.logic.taskItems.length;a++){var b=this.logic.taskItems[a];util.slide(b.group,{delay:100*a,time:500,x:-250,alpha:1,ease:Phaser.Easing.Back.Out})}game.time.events.add(1100,this.showComplete,this)},showComplete:function(){cmd.taskStartSignal.dispatch()},cheatClick:function(){cmd.levelCompleteSignal.dispatch()},update:function(){this.logic.update()},homeClick:function(){fader.fade(this.gotoMainMenu,this)
},gotoMainMenu:function(){sounds.stopLevelMusic(),game.state.start("MainMenu")},shutdown:function(){this.logic.destroy()}},App.MainMenuState=function(){},App.MainMenuState.prototype={create:function(){this.add.sprite(0,0,"cuteBack1.jpg"),this.title=new App.GameTitle(Config.WIDTH/2,220),this.playBt=new App.MyButton("playButton",this.playClick,this,{x:400,y:500,center:!0,wobble:!1}),util.pulse(this.playBt.bt,.9),this.soundIcon=new App.SoundIcon({x:550,y:500}),this.creditsBt=new App.MyButton("creditsButton",this.creditsClick,this,{x:250,y:500,center:!0,wobble:!0});var a="v "+Config.VERSION,b=this.add.text(5,Config.HEIGHT-5,a,{font:"12px Arial",fill:"#000000"});b.anchor.set(0,1),Config.ANIMATION&&this.showWithTweens(),App.Fader.SHOULD_FADE_OUT&&fader.fadeOut()},showWithTweens:function(){util.slide(this.title.group,{delay:500,time:1e3,y:-400,alpha:1,ease:Phaser.Easing.Back.Out}),util.showWithScale(this.creditsBt.bt,{delay:1e3}),util.showWithScale(this.soundIcon.group,{delay:1200}),util.showWithAlpha(this.playBt.bt,{delay:1500})},playClick:function(){fader.fade(this.startGame,this)},startGame:function(){cmd.gameStart()},creditsClick:function(){new App.CreditsView}},App.PreloaderState=function(){},App.PreloaderState.prototype={preload:function(){this.add.sprite(0,0,"cuteBack1.jpg");var a,b=["fader","blackBack"],c=["sndClick","sndTick","sndLevelComplete","sndCorrect","sndBell","sndMusic"];for(a=0;a<b.length;a++){var d=-1==b[a].indexOf(".jpg")?b[a]+".png":b[a];this.load.image(b[a],"assets/images/"+d)}for(a=0;a<c.length;a++){var e=c[a]+".mp3",f=c[a]+".ogg";this.load.audio(c[a],["assets/sounds/"+e,"assets/sounds/"+f])}this.load.atlasJSONHash("atlas","assets/images/atlas.png","assets/images/atlas.json"),this.load.json("jsonLevels","assets/levels/levels.json"),this.holder=this.game.add.group();var g=200,h=260;this.preloadBar=this.add.sprite(g+7,h+7,"preloadBar",null,this.holder),this.add.sprite(g,h,"preloadBarHolder",null,this.holder),this.titleTf=this.game.add.text(Config.WIDTH/2,235,"ЗАГРУЗКА...",{font:"bold 40px Arial",fill:"#FFFFFF"},this.holder),this.titleTf.anchor.set(.5,.5),this.progressTxt=this.game.add.text(Config.WIDTH/2,330,"0%",{font:"bold 40px Arial",fill:"#FFFFFF"},this.holder),this.progressTxt.anchor.set(.5,.5),this.load.setPreloadSprite(this.preloadBar),this.load.onFileComplete.add(this.fileLoaded,this)},fileLoaded:function(a){this.progressTxt.setText(a+"%")},create:function(){if(Config.ANIMATION){var a=this.game.add.tween(this.holder).to({alpha:0,y:this.holder.y+60},400,Phaser.Easing.Linear.None,!0);a.onComplete.addOnce(this.preloaderComplete,this)}else this.preloaderComplete()},preloaderComplete:function(){fader=new App.Fader(this.game),cmd=new App.Commands,data=new App.Data,sounds=new App.Sounds,util=new App.Util,this.game.state.start("MainMenu")}};